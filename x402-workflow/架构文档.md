# x402 Payment Protocol

> HTTP 402 payment protocol for AI Agent autonomous payments

## Quick Start

```bash
# Install dependencies
npm install

# Start all services (Merchant:3000, Facilitator:3001, Frontend:5173)
npm run dev

# Open browser
http://localhost:5173
```

**Test Flow:**
1. Click "Connect Wallet" (uses test private key)
2. Select a product and click "Buy"
3. Watch the 7-step payment flow execute automatically

---

## Architecture

```
┌──────────┐     ┌──────────┐     ┌─────────────┐     ┌────────────┐
│  User    │────▶│ Frontend │────▶│  Merchant   │────▶│ Facilitator│
│ (Wallet) │     │  (:5173) │     │   (:3000)   │     │  (:3001)   │
└──────────┘     └──────────┘     └─────────────┘     └─────┬──────┘
                                                            │
                                                   ┌────────▼────────┐
                                                   │   Blockchain    │
                                                   │ (Avalanche Fuji)│
                                                   └─────────────────┘
```

| Service | Port | Role |
|---------|------|------|
| Merchant | 3000 | Product API, 402 response |
| Facilitator | 3001 | Policy validation, on-chain execution |
| Frontend | 5173 | Workflow visualization |

---

## Payment Flow (7 Steps)

```
1. User Request      → User initiates purchase
2. HTTP Request      → POST /api/buy/:productId
3. 402 Response      → Server returns payment challenge
4. Sign Auth         → User signs EIP-712 authorization
5. Execute TX        → Facilitator validates & executes
6. TX Confirmed      → Blockchain confirms transfer
7. Complete          → Server delivers resource
```

---

## Project Structure

```
x402-workflow/
├── package.json              # Root config, one-click startup
├── x402-merchant/            # Merchant service
│   └── src/
│       ├── controllers/      # Product & payment handlers
│       ├── utils/x402.ts     # 402 response builder
│       └── data/products.ts  # Product catalog
├── x402-facilitator/         # Payment facilitator
│   └── src/
│       ├── services/
│       │   ├── executor.ts       # On-chain execution
│       │   └── policyValidator.ts # 7-check validation
│       └── store/            # User policies, merchant whitelist
└── x402-frontend/            # Demo frontend
    └── src/main.js           # Wallet, signing, workflow UI
```

---

## API Reference

### Merchant

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/products` | List products |
| POST | `/api/buy/:id` | Purchase (triggers 402 or completes) |

### Facilitator

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/pay` | Execute payment |
| GET | `/api/merchants` | List whitelisted merchants |
| GET | `/api/policy/:address` | Get user policy |

---

## 402 Response Format

```json
{
  "x402Version": 1,
  "accepts": [{
    "scheme": "exact",
    "network": "avalanche-fuji",
    "maxAmountRequired": "20000",
    "payTo": "0xe29e9c1ea625ef783A688157Fe17b6679EEaD09c",
    "asset": "0x5425890298aed601595a70AB815c96711a31Bc65"
  }],
  "error": "X-PAYMENT header is required"
}
```

---

## EIP-712 Signature

```typescript
// Domain
{ name: 'USD Coin', version: '2', chainId: 43113, verifyingContract: USDC_ADDRESS }

// Message (TransferWithAuthorization)
{ from, to, value, validAfter, validBefore, nonce }
```

---

## Policy Validation (7 Checks)

1. Merchant whitelisted
2. User authorized merchant
3. Amount ≤ transaction limit
4. Amount ≤ daily limit
5. Signature `from` matches user
6. Signature `to` matches merchant
7. Signature `value` matches amount

---

## Network Config

| Item | Value |
|------|-------|
| Network | Avalanche Fuji Testnet |
| Chain ID | 43113 |
| USDC | `0x5425890298aed601595a70AB815c96711a31Bc65` |
| RPC | `https://api.avax-test.network/ext/bc/C/rpc` |
| Faucet | https://faucet.avax.network/ |
| Explorer | https://testnet.snowtrace.io/ |

---

## Environment Variables

```bash
# x402-merchant
MERCHANT_PRIVATE_KEY=0x...
MERCHANT_ADDRESS=0x...

# x402-facilitator
FACILITATOR_PRIVATE_KEY=0x...
```

---

## Development

```bash
# Run individual services
cd x402-merchant && npm run dev
cd x402-facilitator && npm run dev
cd x402-frontend && npm run dev

# Build for production
npm run build
```

---

## References

- [x402 Protocol](https://github.com/coinbase/x402)
- [EIP-712](https://eips.ethereum.org/EIPS/eip-712)
- [EIP-3009](https://eips.ethereum.org/EIPS/eip-3009)
